<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentiment Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-4">Sentiment Analysis Dashboard</h1>
        <div class="mb-4">
            <label class="inline-flex items-center">
                <input type="checkbox" id="showMarkers" class="form-checkbox">
                <span class="ml-2">Show Markers</span>
            </label>
            <label class="inline-flex items-center ml-4">
                <span class="mr-2">Rolling Window:</span>
                <input type="number" id="rollingWindow" class="form-input w-20" value="28">
            </label>
            <label class="inline-flex items-center ml-4">
                <span class="mr-2">Start Date:</span>
                <input type="date" id="startDate" class="form-input" value="2023-12-10">
            </label>
            <label class="inline-flex items-center ml-4">
                <span class="mr-2">End Date:</span>
                <input type="date" id="endDate" class="form-input" value="2026-11-15">
            </label>
            <button id="updateChart" class="ml-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Update Chart
            </button>
        </div>
        <div id="chart" class="bg-white p-4 rounded-lg shadow-lg"></div>
    </div>

    <script>
        let chart;

        function updateChart() {
            const showMarkers = document.getElementById('showMarkers').checked;
            const rollingWindow = document.getElementById('rollingWindow').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            fetch(`/data?show_markers=${showMarkers}&rolling_window=${rollingWindow}&start_date=${startDate}&end_date=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    const options = {
                        series: data.series,
                        chart: {
                            type: 'line',
                            height: 600,
                            zoom: {
                                type: 'x',
                                enabled: true,
                                autoScaleYaxis: true
                            },
                        },
                        dataLabels: {
                            enabled: false
                        },
                        stroke: {
                            curve: 'smooth',
                            width: 2,
                        },
                        title: {
                            text: 'Average Unweighted and Weighted Sentiment (Rescaled)',
                            align: 'left'
                        },
                        grid: {
                            row: {
                                colors: ['#f3f3f3', 'transparent'],
                                opacity: 0.5
                            },
                        },
                        xaxis: {
                            type: 'datetime',
                        },
                        yaxis: {
                            title: {
                                text: 'Average Sentiment (0 to 100)'
                            },
                            min: data.yaxis && data.yaxis.min !== undefined ? data.yaxis.min : 0,
                            max: data.yaxis && data.yaxis.max !== undefined ? data.yaxis.max : 100
                        },
                        legend: {
                            position: 'top',
                            horizontalAlign: 'right',
                            floating: true,
                            offsetY: -25,
                            offsetX: -5
                        },
                        annotations: {
                            xaxis: data.markers.map(marker => ({
                                x: marker.x,
                                borderColor: '#775DD0',
                                label: {
                                    borderColor: '#775DD0',
                                    style: {
                                        color: '#fff',
                                        background: '#775DD0',
                                    },
                                    text: marker.text,
                                }
                            }))
                        }
                    };

                    if (chart) {
                        chart.updateOptions(options);
                    } else {
                        chart = new ApexCharts(document.querySelector("#chart"), options);
                        chart.render();
                    }
                });
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateChart();
            document.getElementById('updateChart').addEventListener('click', updateChart);
        });
    </script>
</body>
</html>